{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "functions": [],
  "parameters": {
    "agency_abbreviation": {
      "type": "string"
    },
    "agency_ori": {
      "type": "string"
    },
    "application": {
      "defaultValue": "ripa",
      "type": "string"
    },
    "auth_tenant_id": {
      "type": "string"
    },
    "doj_sftp_disabled": {
      "type": "string",
      "defaultValue": "false"
    },
    "auth_app_id": {
      "type": "string"
    },
    "auth_fqdn": {
      "type": "string"
    },
    "user_tags": {
      "type": "object",
      "defaultValue": {}
    },
    "storage_ep_suff": {
      "defaultValue": "core.usgovcloudapi.net",
      "type": "string"
    },
    "fa_hostnamessl_ep_suff": {
      "defaultValue": ".azurewebsites.us",
      "type": "string"
    },
    "fa_hostnamessl_scm_ep_suff": {
      "defaultValue": ".scm.azurewebsites.us",
      "type": "string"
    },
    "submission_fa_name": {
      "defaultValue": "submission-fa",
      "type": "string"
    },
    "use32BitWorkerProcess": {
      "defaultValue": false,
      "type": "bool"
    },
    "linuxFxVersion": {
      "defaultValue": "dotnet|3.1",
      "type": "string"
    },
    "vaults_kv_name": {
      "defaultValue": "kv",
      "type": "string"
    },
    "components_ai_name": {
      "defaultValue": "ai",
      "type": "string"
    },
    "serverfarms_submission_ASP_name": {
      "defaultValue": "submission-fa-asp",
      "type": "string"
    },
    "service_apim_name": {
      "defaultValue": "apim",
      "type": "string"
    },
    "databaseAccounts_cdb_name": {
      "defaultValue": "cdb",
      "type": "string"
    },
    "storageAccounts_functionssa_name": {
      "defaultValue": "fnsa",
      "type": "string"
    },
    "vaults_kv_secrets_key0": {
      "type": "string",
      "defaultValue": "ServiceBusConnection"
    },
    "vaults_kv_secrets_key1": {
      "type": "string",
      "defaultValue": "dbkey1"
    },
    "vaults_kv_secrets_key3": {
      "type": "string",
      "defaultValue": "ripaStorage"
    },
    "vaults_kv_secrets_key6": {
      "type": "string",
      "defaultValue": "SftpKey"
    },
    "vaults_kv_secrets_key7": {
      "type": "string",
      "defaultValue": "SftpHost"
    },
    "vaults_kv_secrets_key8": {
      "type": "string",
      "defaultValue": "SftpPassword"
    },
    "vaults_kv_secrets_key9": {
      "type": "string",
      "defaultValue": "SftpUsername"
    },
    "submission_fa_config_storage_container_prefix_results": {
      "type": "string",
      "defaultValue": "result"
    },
    "submission_fa_config_storage_container_prefix_submissions": {
      "type": "string",
      "defaultValue": "submission"
    },
    "submission_fa_config_storage_container_prefix_cpra": {
      "type": "string",
      "defaultValue": "cpra"
    },
    "doj_environment": {
      "type": "string",
      "defaultValue": "PROD"
    },
    "submission_fa_config_sftp_input_path": {
      "type": "string",
      "defaultValue": "/incoming_to_DOJ/JSON/"
    },
    "submission_fa_config_sftp_output_path": {
      "type": "string",
      "defaultValue": "/responses_from_DOJ/"
    },
    "submission_fa_config_sftp_port": {
      "type": "int",
      "defaultValue": 22
    },
    "dbaccount_sqlDb_name": {
      "type": "string",
      "defaultValue": "ripastops"
    },
    "dbaccount_sqlDb_user_container_name": {
      "type": "string",
      "defaultValue": "userprofile"
    },
    "dbaccount_sqlDb_stop_container_name": {
      "type": "string",
      "defaultValue": "stop"
    },
    "dbaccount_sqlDb_submission_container_name": {
      "type": "string",
      "defaultValue": "submission"
    },
    "utcNowValue": {
      "type": "string",
      "defaultValue": "[utcNow('yyyyMMDDHHmmssFFFF')]"
    }
  },
  "variables": {
    "components_ripa_ai_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('components_ai_name'))]",
    "databaseAccounts_ripa_cdb_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('databaseAccounts_cdb_name'))]",
    "serverfarms_submission_ASP_riparg_af76_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('serverfarms_submission_ASP_name'))]",
    "service_ripa_apim_wus2_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('service_apim_name'))]",
    "sites_ripa_submission_fa_name": "[concat(parameters('agency_abbreviation'),'-', parameters('application'),'-', parameters('submission_fa_name'))]",
    "storageAccounts_ripafnsa_name": "[concat(parameters('agency_abbreviation'), replace(parameters('application'), '-', ''), parameters('storageAccounts_functionssa_name'))]",
    "vaults_ripa_kv_name": "[concat(parameters('agency_abbreviation'), parameters('application'), toLower(take(uniqueString(parameters('utcNowValue')), 3)), parameters('vaults_kv_name'))]",
    "user_fa_keyvault_referencestring": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key1'),')')]",
    "keyvault_secret_ripa_storage": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key3'),')')]",
    "keyvault_secret_sftp_key": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key6'),')')]",
    "keyvault_secret_sftp_host": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key7'),')')]",
    "keyvault_secret_sftp_password": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key8'),')')]",
    "keyvault_secret_sftp_username": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key9'),')')]",
    "keyvault_secret_servicebus_connection_string": "[concat('@Microsoft.KeyVault(SecretUri=https://',variables('vaults_ripa_kv_name'),'.usgovcloudapi.net/secrets/', parameters('vaults_kv_secrets_key0'),')')]",
    "doj_inbound_folder": "[concat('/', parameters('doj_environment'), parameters('submission_fa_config_sftp_input_path'))]",
    "doj_outbound_folder": "[concat('/', parameters('doj_environment'), parameters('submission_fa_config_sftp_output_path'))]",
    "template_version": "#{TEMPLATE_VERSION}#",
    "default_tags": {
      "application": "ripa",
      "agency": "[parameters('agency_abbreviation')]",
      "agency_ori": "[parameters('agency_ori')]",
      "template_version": "[variables('template_version')]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/deploymentScripts",
      "apiVersion": "2020-10-01",
      "name": "[concat(toLower(take(uniqueString(parameters('utcNowValue')), 3)), 'cssa-app-update-runonce-deleteme-ifucme-dps')]",
      "location": "[resourceGroup().location]",
      "kind": "AzurePowerShell",
      "dependsOn": [],
      "tags": {},
      "properties": {
        "forceUpdateTag": "newGuid()",
        "containerSettings": {
          "containerGroupName": "[concat(toLower(take(uniqueString(parameters('utcNowValue')), 3)), 'cssa-app-update-runonce-deleteme-ifucme-dps')]"
        },
        "storageAccountSettings": {
          "storageAccountName": "#{CSSA_STORAGE_ACCOUNT_NAME}#",
          "storageAccountKey": "#{CSSA_STORAGE_ACCOUNT_KEY}#"
        },
        "azPowerShellVersion": "3.0",
        "environmentVariables": [
          {
            "name": "CSSA_SP_APP_ID",
            "secureValue": "#{CSSA_SP_APP_ID}#"
          },
          {
            "name": "CSSA_SP_SECRET",
            "secureValue": "#{CSSA_SP_SECRET}#"
          },
          {
            "name": "CSSA_TENANT_ID",
            "value": "#{CSSA_TENANT_ID}#"
          },
          {
            "name": "APP_SUBSCRIPTION_ID",
            "value": "[subscription().subscriptionId]"
          },
          {
            "name": "APP_RESOURCE_GROUP_NAME",
            "value": "[resourceGroup().name]"
          },
          {
            "name": "DEPLOY_WEB_CONFIG_JSON",
            "value": "False"
          }
        ],
        "primaryScriptUri": "#{ZMP-__TEMPLATE_VERSION__-IMPORT-ALLRIPAAPPLICATIONS-PS1-SAS-URL}#",
        "supportingScriptUris": [
          "#{ZMP-__TEMPLATE_VERSION__-IMPORT-APIMAPIS-PSM1-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-NEW-FUNCTIONHOSTKEY-PSM1-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-NEW-RIPAAPIMBACKEND-PSM1-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-DOMAIN-ZIP-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-STOP-ZIP-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-SUBMISSION-ZIP-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-TEXTANALYTICS-ZIP-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-USERPROFILE-ZIP-SAS-URL}#",
          "#{ZMP-__TEMPLATE_VERSION__-UI-ZIP-SAS-URL}#"
        ],
        "timeout": "PT4H",
        "cleanupPreference": "OnExpiration",
        "retentionInterval": "PT4H"
      }
    },
    {
      "type": "Microsoft.Web/sites",
      "apiVersion": "2018-11-01",
      "name": "[variables('sites_ripa_submission_fa_name')]",
      "location": "[resourceGroup().location]",
      "identity": {
        "type": "SystemAssigned"
      },
      "kind": "functionapp,linux",
      "tags": "[union(variables('default_tags'), if(contains(parameters('user_tags'), 'Microsoft.Web/sites'), parameters('user_tags')['Microsoft.Web/sites'], json('{}')))]",
      "properties": {
        "enabled": true,
        "hostNameSslStates": [
          {
            "name": "[concat(variables('sites_ripa_submission_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Standard"
          },
          {
            "name": "[concat(variables('sites_ripa_submission_fa_name'), parameters('fa_hostnamessl_scm_ep_suff'))]",
            "sslState": "Disabled",
            "hostType": "Repository"
          }
        ],
        "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('serverfarms_submission_ASP_riparg_af76_name'))]",
        "reserved": true,
        "isXenon": false,
        "hyperV": false,
        "siteConfig": {
          "appSettings": [
            {
              "name": "FUNCTIONS_EXTENSION_VERSION",
              "value": "~3"
            },
            {
              "name": "FUNCTIONS_WORKER_RUNTIME",
              "value": "dotnet"
            },
            {
              "name": "AzureWebJobs.ServiceBusSubmissionConsumer.Disabled",
              "value": "true"
            },
            {
              "name": "AzureWebJobsStorage",
              "value": "[concat('DefaultEndpointsProtocol=https;AccountName=',variables('storageAccounts_ripafnsa_name'),';AccountKey=',listKeys(resourceId('Microsoft.Storage/storageAccounts', variables('storageAccounts_ripafnsa_name')), '2019-06-01').keys[0].value,';EndpointSuffix=', parameters('storage_ep_suff'))]"
            },
            {
              "name": "APPINSIGHTS_INSTRUMENTATIONKEY",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).InstrumentationKey]"
            },
            {
              "name": "APPLICATIONINSIGHTS_CONNECTION_STRING",
              "value": "[reference(concat('microsoft.insights/components/', variables('components_ripa_ai_name'))).ConnectionString]"
            },
            {
              "name": "Account",
              "value": "[reference(resourceId('Microsoft.DocumentDb/databaseAccounts', variables('databaseAccounts_ripa_cdb_name'))).documentEndpoint]"
            },
            {
              "name": "DatabaseName",
              "value": "[parameters('dbaccount_sqlDb_name')]"
            },
            {
              "name": "Key",
              "value": "[variables('user_fa_keyvault_referencestring')]"
            },
            {
              "name": "ContainerNameSubmissions",
              "value": "[parameters('dbaccount_sqlDb_submission_container_name')]"
            },
            {
              "name": "ContainerNameStops",
              "value": "[parameters('dbaccount_sqlDb_stop_container_name')]"
            },
            {
              "name": "ContainerPrefixSubmissions",
              "value": "[parameters('submission_fa_config_storage_container_prefix_submissions')]"
            },
            {
              "name": "ContainerPrefixCpra",
              "value": "[parameters('submission_fa_config_storage_container_prefix_cpra')]"
            },
            {
              "name": "ContainerPrefixResults",
              "value": "[parameters('submission_fa_config_storage_container_prefix_results')]"
            },
            {
              "name": "UserProfileContainerName",
              "value": "[parameters('dbaccount_sqlDb_user_container_name')]"
            },
            {
              "name": "RipaStorage",
              "value": "[variables('keyvault_secret_ripa_storage')]"
            },
            {
              "name": "SftpInputPath",
              "value": "[variables('doj_inbound_folder')]"
            },
            {
              "name": "SftpOutputPath",
              "value": "[variables('doj_outbound_folder')]"
            },
            {
              "name": "SftpPort",
              "value": "[parameters('submission_fa_config_sftp_port')]"
            },
            {
              "name": "SftpHost",
              "value": "[variables('keyvault_secret_sftp_host')]"
            },
            {
              "name": "SftpUserName",
              "value": "[variables('keyvault_secret_sftp_username')]"
            },
            {
              "name": "SftpPassword",
              "value": "[variables('keyvault_secret_sftp_password')]"
            },
            {
              "name": "SftpKey",
              "value": "[variables('keyvault_secret_sftp_key')]"
            },
            {
              "name": "SftpDisabled",
              "value": "[parameters('doj_sftp_disabled')]"
            },
            {
              "name": "ripa_app_id",
              "value": "[parameters('auth_app_id')]"
            },
            {
              "name": "ripa_tenant_id",
              "value": "[parameters('auth_tenant_id')]"
            },
            {
              "name": "ripa_tenant_name",
              "value": "[parameters('auth_fqdn')]"
            },
            {
              "name": "ServiceBusConnection",
              "value": "[variables('keyvault_secret_servicebus_connection_string')]"
            }
          ],
          "use32BitWorkerProcess": "[parameters('use32BitWorkerProcess')]",
          "linuxFxVersion": "[parameters('linuxFxVersion')]",
          "scmIpSecurityRestrictionsUseMain": true,
          "numberOfWorkers": 1
        },
        "scmSiteAlsoStopped": false,
        "clientAffinityEnabled": false,
        "clientCertEnabled": false,
        "hostNamesDisabled": false,
        "containerSize": 1536,
        "dailyMemoryTimeQuota": 0,
        "httpsOnly": true,
        "redundancyMode": "None"
      }
    },
    {
      "type": "Microsoft.Web/sites/config",
      "apiVersion": "2018-11-01",
      "name": "[concat(variables('sites_ripa_submission_fa_name'), '/web')]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_submission_fa_name'))]"
      ],
      "properties": {
        "numberOfWorkers": 1,
        "defaultDocuments": [],
        "netFrameworkVersion": "v4.0",
        "linuxFxVersion": "[parameters('linuxFxVersion')]",
        "requestTracingEnabled": false,
        "remoteDebuggingEnabled": false,
        "httpLoggingEnabled": false,
        "remoteDebuggingVersion": "VS2019",
        "logsDirectorySizeLimit": 35,
        "detailedErrorLoggingEnabled": false,
        "publishingUsername": "$variables('sites_ripa_submission_fa_name')",
        "azureStorageAccounts": {},
        "scmType": "None",
        "use32BitWorkerProcess": false,
        "webSocketsEnabled": false,
        "alwaysOn": false,
        "managedPipelineMode": "Integrated",
        "virtualApplications": [
          {
            "virtualPath": "/",
            "physicalPath": "site\\wwwroot",
            "preloadEnabled": false
          }
        ],
        "loadBalancing": "LeastRequests",
        "experiments": {
          "rampUpRules": []
        },
        "autoHealEnabled": false,
        "cors": {
          "allowedOrigins": ["*"],
          "supportCredentials": false
        },
        "localMySqlEnabled": false,
        "ipSecurityRestrictions": [
          {
            "ipAddress": "[concat(first(reference(concat('Microsoft.ApiManagement/service/',  variables('service_ripa_apim_wus2_name')), '2019-12-01','Full').properties.publicIpAddresses),'/32')]",
            "action": "Allow",
            "priority": 100,
            "name": "Apim-publicIp",
            "description": "Allow Apim PublicIp"
          },
          {
            "ipAddress": "0.0.0.0/0",
            "action": "Deny",
            "tag": "Default",
            "priority": 1000,
            "name": "NoInternet",
            "description": "Stop all Internet traffic"
          },
          {
            "ipAddress": "Any",
            "action": "Deny",
            "priority": 2147483647,
            "name": "Deny all",
            "description": "Deny all access"
          }
        ],
        "scmIpSecurityRestrictionsUseMain": true,
        "http20Enabled": false,
        "minTlsVersion": "1.2",
        "ftpsState": "AllAllowed",
        "reservedInstanceCount": 0
      }
    },
    {
      "type": "Microsoft.Web/sites/hostNameBindings",
      "apiVersion": "2018-11-01",
      "name": "[concat(variables('sites_ripa_submission_fa_name'), '/', variables('sites_ripa_submission_fa_name'), parameters('fa_hostnamessl_ep_suff'))]",
      "location": "[resourceGroup().location]",
      "dependsOn": [
        "[resourceId('Microsoft.Web/sites', variables('sites_ripa_submission_fa_name'))]"
      ],
      "properties": {
        "siteName": "[variables('sites_ripa_submission_fa_name')]",
        "hostNameType": "Verified"
      }
    }
  ],
  "outputs": {}
}
